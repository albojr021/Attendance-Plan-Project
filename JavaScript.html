<script>
  // NEW: Include jQuery first (Select2 dependency)
  document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"><\/script>');
  // NEW: Include Select2
  document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"><\/script>');
  
  // Global state variables
  let contractList = [];
  let currentContract = null;
  const CONTRACT_ID_CACHE_KEY = 'current_contract_id'; 
  
  // *** DATE NAVIGATION VARIABLE ***
  let currentPlanningDate = new Date(); 
  // Ang status codes
  const fixedStatusCodes = ['RD', 'RH', 'SH', '']; 
  const shiftPeriods = [
    { key: '1stHalf', label: '1st Half (1st to 15th)' },
    { key: '2ndHalf', label: '2nd Half (16th to End)' }
  ];
  const maxDays = 31; 
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  // *** FIXED STATUS OPTIONS PARA SA FLOATING DROPDOWN ***
  let selectedCellData = {}; 

  // *** NEW: Global state para sa Bulk Selection ***
  let isBulkSelectionMode = false;
  let bulkSelectedCells = []; // Stores the TD elements of selected cells
  // ---------------------------------------------
  
  // *** NEW: Global state para sa tracking ng changes ***
  let pendingAttendanceChanges = {}; // Key: personnelId_DayKey_ShiftKey, Value: Status
  // UPDATED: Ngayon may `isDeleted` property na
  let pendingEmployeeInfoChanges = {}; // Key: original/oldPersonnelId, Value: {id, name, position, area, isNew, isDeleted}
  
  // REMOVED: isScheduleLocked global state
  // ---------------------------------------------

  const fixedStatusOptions = [
    { value: 'RD', label: 'Rest Day (RD)', color: 'status-rd text-red-700' },
    { value: 'RH', label: 'Regular Holiday (RH)', color: 'status-rh text-blue-700' },
    { value: 'SH', label: 'Special Holiday (SH)', color: 'status-sh text-yellow-700' },
    { value: '', label: 'Clear/Blank (Work Schedule)', color: 'bg-gray-200 text-gray-700' },
  ];
  
  // NEW: Global variable para sa validation (HH:MM-HH:MM) - HINDI NA GANOONG KA-STRICT DAHIL SA TYPE="TIME"
  const TIME_FORMAT_REGEX = /^([01]?[0-9]|2[0-3]):[0-5][0-9]-([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
  // NEW: Regex for Personnel Info validation
  const PERSONNEL_ID_REGEX = /^[0-9]+$/; // Only numbers
  // FIX: Nagdagdag ng DASH (-) sa allowed characters
  const SAFE_TEXT_REGEX = /^[A-Z0-9\s.,-]+$/; // Letters, Numbers, Space, Period, Comma, and DASH (-)
  // ---------------------------------------------

  // --- NEW: Time Option Generator for Dropdowns ---
  function generateTimeOptions() {
      const times = [];
      for (let h = 0; h < 24; h++) {
          for (let m = 0; m < 60; m += 30) {
              const hour = String(h).padStart(2, '0');
              const minute = String(m).padStart(2, '0');
              times.push(`${hour}:${minute}`);
          }
      }
      return times;
  }
  const TIME_OPTIONS = generateTimeOptions();


  // --- NEW: FUNCTION PARA I-CHECK KUNG DUPLICATE ANG ID ---
  function isDuplicateId(newId, originalSavedId, currentNo) {
      const trimmedNewId = newId.trim();
      if (!trimmedNewId) return false;

      // 1. Check against SAVED employees (using originalSavedId as exclusion)
      if (currentContract && currentContract.employees) {
          const savedConflict = currentContract.employees.some(emp => {
              const savedId = (emp.id || '').trim();
              // I-check kung nag-match ang ID, PERO hindi ito ang original ID ng row na ine-edit
              return savedId === trimmedNewId && savedId !== originalSavedId;
          });
          if (savedConflict) return true;
      }

      // 2. Check against PENDING changes (using row key exclusion)
      const pendingKeys = Object.keys(pendingEmployeeInfoChanges);
      for (const key of pendingKeys) {
          // Stable key: original ID (kung meron) o TEMP_N (kung bago)
          const isCurrentRowPending = (key === originalSavedId) || (key === `TEMP_${currentNo}`);
          if (isCurrentRowPending) continue; // Skip ang row na kasalukuyang ine-edit

          const pendingChange = pendingEmployeeInfoChanges[key];
          // Tiyakin na hindi deleted ang pending change na ito
          if (pendingChange.isDeleted) continue; 

          const pendingId = (pendingChange.id || '').trim();
          if (pendingId === trimmedNewId) return true;
      }
      
      return false;
  }
  // --- END DUPLICATE ID FUNCTION ---

  // *** NEW: FUNCTION PARA I-CHECK KUNG DUPLICATE ANG NAME ***
  function isDuplicateName(newName, originalSavedId, currentNo) {
      const trimmedNewName = newName.trim().toUpperCase();
      if (!trimmedNewName) return false;
      
      // 1. Check against SAVED employees (using originalSavedId as exclusion)
      if (currentContract && currentContract.employees) {
          const savedConflict = currentContract.employees.some(emp => {
              const savedName = (emp.name || '').trim().toUpperCase();
              // I-check kung nag-match ang Name, PERO hindi ito ang original ID ng row na ine-edit
              return savedName === trimmedNewName && (emp.id || '') !== originalSavedId;
          });
          if (savedConflict) return true;
      }

      // 2. Check against PENDING changes (using row key exclusion)
      const pendingKeys = Object.keys(pendingEmployeeInfoChanges);
      for (const key of pendingKeys) {
          // Stable key: original ID (kung meron) o TEMP_N (kung bago)
          const isCurrentRowPending = (key === originalSavedId) || (key === `TEMP_${currentNo}`);
          if (isCurrentRowPending) continue; // Skip ang row na kasalukuyang ine-edit

          const pendingChange = pendingEmployeeInfoChanges[key];
          // Tiyakin na hindi deleted ang pending change na ito
          if (pendingChange.isDeleted) continue; 

          // Kunin ang pending name. Pwedeng ang new value (kung nag-iba na) o ang original name (kung name field lang ang nag-iba)
          const pendingName = (pendingChange.name || '').trim().toUpperCase();
          if (pendingName === trimmedNewName) return true;
      }
      
      return false;
  }
  // --- END DUPLICATE NAME FUNCTION ---
  
  // --- HELPER FUNCTION: KUNIN ANG ACTIVE EMPLOYEES SA GRID ---
  function getActiveEmployeesInGrid() {
    const activeEmployees = [];
    const gridRows = document.querySelectorAll('#attendance-table-container tbody tr');
    
    gridRows.forEach(row => {
        const stableKey = row.dataset.stableKey;
        const pendingInfo = pendingEmployeeInfoChanges[stableKey];
        
        // Skip kung marked for deletion
        if (pendingInfo && pendingInfo.isDeleted) return; 

        const employee = currentContract.employees.find(e => e.id === stableKey) || { 
            id: '', name: '', position: '', area: '' 
        };

        const displayId = (pendingInfo && pendingInfo.id) ? pendingInfo.id : employee.id;
        const displayName = (pendingInfo && pendingInfo.name) ? pendingInfo.name : employee.name;
        
        // I-check kung ang row ay may Personnel ID at Name
        if (displayId.trim() && displayName.trim()) {
            // Kunin ang active schedule cells
            const planCells = row.querySelectorAll('.cell-container');
            
            const cellData = [];
            planCells.forEach(cell => {
                // Gamitin ang innerHTML para kunin ang displayed status (Schedule, RD, RH, SH, o '')
                const status = cell.querySelector('.attendance-cell-bg').textContent.trim();
                const dayKey = cell.dataset.dayKey;
                
                cellData.push({ dayKey, status });
            });

            activeEmployees.push({
                id: displayId.trim(),
                name: displayName.trim(),
                planCells: cellData
            });
        }
    });
    
    return activeEmployees;
  }
  // --- END HELPER FUNCTION ---


  // --- UI HANDLERS ---

  function toggleLoading(isLoading) {
    document.getElementById('loading-alert').classList.toggle('hidden', !isLoading);
  }

  function showNotification(message, isSuccess = true) {
    const notification = document.getElementById('notification-area');
    notification.textContent = message;
    notification.classList.remove('opacity-0', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
    
    if (isSuccess) {
      notification.classList.add('bg-green-100', 'text-green-800');
    } else {
      notification.classList.add('bg-red-100', 'text-red-800');
    }

    notification.classList.add('opacity-100');
    
    setTimeout(() => {
      notification.classList.remove('opacity-100');
      notification.classList.add('opacity-0');
    }, 3000);
  }

  function handleError(error) {
    console.error("APPS SCRIPT ERROR:", error);
    showNotification(`Error: ${error.message || 'An unknown error occurred in the script.'}`, false);
    toggleLoading(false);
  }
  
  // --- NEW: RELOAD PLAN HELPER ---
  function reloadPlanAndCheckExistence() {
      if (currentContract && currentContract.sfcRef) {
          // I-clear ang planning area display immediately to show loading state
          document.getElementById('planning-area').classList.add('hidden'); 
          checkIfPlanExists(currentContract.sfcRef);
      } else {
          renderAttendancePlan(); // Fallback
      }
  }


  // --- CONTRACT SELECTION & DATA FETCHING ---

  function handleContractList(contracts) {
    contractList = contracts;
    const select = document.getElementById('contract-select');
    select.innerHTML = '<option value="">-- Choose Contract Group ID --</option>';

    contracts.forEach(contract => {
      const option = document.createElement('option');
      option.value = contract.id;
      // Gumamit ng Contract ID at SFC Ref# para mas madaling hanapin
      option.textContent = `${contract.id} - ${contract.status} (Ref#: ${contract.sfcRef})`;
      select.appendChild(option);
    });

    // NEW: I-initialize ang Select2 sa iyong dropdown
    // Gumamit ng setTimeout para tiyakin na fully loaded ang Select2 JS
    setTimeout(() => {
        // I-set ang minimum results for search sa Infinity (default), o pwede rin gawing 1
        $('#contract-select').select2({
            placeholder: "-- Choose Contract Group ID --",
            allowClear: true,
            width: '100%',
        }).on('select2:select', handleSelect2Change) // Call new handler on select
          .on('select2:unselect', handleSelect2Change) // Call new handler on unselect/clear
          .on('change', handleSelect2Change); // General change listener (fallback)

        toggleLoading(false);
    }, 100); 

    // Populate Shift Periods
    const shiftSelect = document.getElementById('shift-period-select');
    shiftPeriods.forEach(period => {
      const option = document.createElement('option');
      option.value = period.key;
      option.textContent = period.label;
      shiftSelect.appendChild(option);
    });

    // Set default shift to 1st Half
    shiftSelect.value = '1stHalf';

    // CRITICAL FIX: Use reloadPlanAndCheckExistence for all navigation
    document.getElementById('shift-period-select').addEventListener('change', reloadPlanAndCheckExistence);
    document.getElementById('prev-month').addEventListener('click', () => { navigateMonth(-1); reloadPlanAndCheckExistence(); });
    document.getElementById('next-month').addEventListener('click', () => { navigateMonth(1); reloadPlanAndCheckExistence(); });
    
    // *** NEW: Listener for Save All Button ***
    document.getElementById('save-all-changes-btn').addEventListener('click', handleSaveAllChanges); 
    
    // *** NEW: Listener for Print Button (Calls server function) ***
    document.getElementById('print-plan-btn').addEventListener('click', handlePrintPlan);

    // *** NEW: Attach Bulk Listeners ***
    document.getElementById('start-bulk-select-btn').addEventListener('click', startBulkSelectionMode);
    document.getElementById('bulk-cancel-btn').addEventListener('click', exitBulkSelectionMode);
    document.getElementById('bulk-save-btn').addEventListener('click', (event) => saveBulkSchedule(event, null));
    
    // REMOVED: Schedule Lock Toggle Button Listener
    
  }

  // NEW: I-create ang handler para sa Select2 change
  function handleSelect2Change(event) {
      // Kunin ang value (contractId) galing sa Select2 element
      const contractId = $('#contract-select').val(); 
      
      if (!contractId || contractId === "") {
          // Logic kapag nag-clear o pumili ng blanko
          document.getElementById('contract-details-area').classList.add('hidden');
          document.getElementById('planning-area').classList.add('hidden');
          document.getElementById('plan-action-area').classList.add('hidden');
          document.getElementById('initial-placeholder').classList.remove('hidden');
          currentContract = null;
          sessionStorage.removeItem(CONTRACT_ID_CACHE_KEY); 
          return;
      }
      
      currentContract = contractList.find(c => c.id === contractId);
      sessionStorage.setItem(CONTRACT_ID_CACHE_KEY, currentContract.id); 
      
      if (currentContract) {
          displayContractDetails(currentContract);
          checkIfPlanExists(currentContract.sfcRef); 
      }
  }


function displayContractDetails(contract) {
    document.getElementById('sfc-ref').textContent = contract.sfcRef;
    document.getElementById('payor-company').textContent = contract.payorCompany;
    document.getElementById('agency').textContent = contract.agency;
    document.getElementById('service-type').textContent = contract.serviceType;
    document.getElementById('head-count').textContent = contract.headCount;
    
    document.getElementById('contract-details-area').classList.remove('hidden');
    // document.getElementById('planning-area').classList.remove('hidden'); // HIDE planning-area
    document.getElementById('initial-placeholder').classList.add('hidden');
    
    // CRITICAL FIX: Huwag ipakita ang action area by default.
    document.getElementById('plan-action-area').classList.add('hidden'); 
}

// NEW: Function to check if the plan sheets already exist
function checkIfPlanExists(sfcRef) {
    toggleLoading(true);
    
    // FIX: Pass Year, Month, and Shift for dynamic sheet check
    const currentYear = currentPlanningDate.getFullYear();
    const currentMonth = currentPlanningDate.getMonth();
    const currentShift = document.getElementById('shift-period-select').value;
    
    google.script.run
        .withSuccessHandler(handlePlanExistence)
        .withFailureHandler(handleError)
        .checkContractSheets(sfcRef, currentYear, currentMonth, currentShift); // Pass all required context
}

// NEW: Handles the response from checkContractSheets
function handlePlanExistence(exists) {
    toggleLoading(false);
    const planArea = document.getElementById('planning-area');
    const actionArea = document.getElementById('plan-action-area');
    const statusText = document.getElementById('plan-status-text');
    const sfcRef = currentContract ? currentContract.sfcRef : null;

    // Laging itago ang load button kapag nag-a-update ng state
    actionArea.classList.add('hidden'); 

    if (exists) {
        // CRITICAL FIX: If Plan exists, Auto-load data immediately.
        statusText.textContent = 'Attendance Plan Status: Plan Ready. Loading...';
        fetchAttendanceData(sfcRef); // Trigger load automatically
    } else {
        // CRITICAL FIX: If plan does NOT exist, auto-render blank grid immediately.
        statusText.textContent = 'Attendance Plan Status: Ready to Plan (New Sheet).';
        showBlankPlan(); // Auto-render blank grid for new plan entry
    }
}

// NEW WORKFLOW: Show blank plan (No server call)
function showBlankPlan() {
    // CRITICAL FIX: Ensure currentContract is properly initialized for rendering
    if (!currentContract) {
        showNotification('Please select a Contract Group ID first.', false);
        return;
    }
    
    currentContract.employees = currentContract.employees || []; // Ensure employees array is available
    currentContract.planMap = {}; // Start with no plan data
    
    // Show planning area and render table
    document.getElementById('planning-area').classList.remove('hidden'); 
    showNotification('Ready to plan. Your plan will be saved as a new sheet on click.', true);

    renderAttendancePlan(); // Render the blank grid
    toggleLoading(false);
}


function fetchAttendanceData(sfcRef) {
    toggleLoading(true);
    pendingAttendanceChanges = {}; 
    pendingEmployeeInfoChanges = {}; 
    
    // FIX: Pass Year, Month, and Shift to the server
    const currentYear = currentPlanningDate.getFullYear();
    const currentMonth = currentPlanningDate.getMonth(); // 0-based month (0=Jan, 10=Nov)
    const currentShift = document.getElementById('shift-period-select').value;


    // Call getAttendancePlan, which now assumes sheets exist
    google.script.run
      .withSuccessHandler(handleAttendanceData)
      .withFailureHandler(handleError)
      .getAttendancePlan(sfcRef, currentYear, currentMonth, currentShift); // PASS YEAR, MONTH & SHIFT
}

// REMOVED: createAndFetchPlan() (Handled by SaveAllChanges)


function handleAttendanceData(data) {
    // data.employees: [{no, id, name, position, area}, ...]
    // data.planMap: {personnelId_DayKey_ShiftKey: Status, ...}
    currentContract.employees = data.employees;
    currentContract.planMap = data.planMap;
    
    // Show planning area and render table
    document.getElementById('planning-area').classList.remove('hidden'); 
    showNotification('Attendance Plan loaded successfully!', true);

    renderAttendancePlan();
    toggleLoading(false);
}

// --- DATE NAVIGATION ---

  function navigateMonth(direction) {
    currentPlanningDate.setMonth(currentPlanningDate.getMonth() + direction);
    // Reset date to day 1 to avoid month skipping issues (e.g., 31st to Feb)
    currentPlanningDate.setDate(1); 
    // Walang renderAttendancePlan() call dito, dahil ang reloadPlanAndCheckExistence() na ang bahala.
    // document.getElementById('shift-period-select').value = '1stHalf'; // Reset to 1st Half - Huwag muna i-reset para sa consistency
  }

  function getDaysInMonth(year, month) {
    return new Date(year, month + 1, 0).getDate();
  }

  function renderAttendancePlan() {
    if (!currentContract) return;

    const year = currentPlanningDate.getFullYear();
    const month = currentPlanningDate.getMonth();
    const daysInMonth = getDaysInMonth(year, month);
    const selectedShift = document.getElementById('shift-period-select').value;
    
    const monthName = currentPlanningDate.toLocaleString('en-US', { month: 'short' }); 

    document.getElementById('current-month-year').textContent = `${currentPlanningDate.toLocaleString('en-US', { month: 'long' })} ${year}`;

    const startDay = selectedShift === '1stHalf' ? 1 : 16;
    const endDay = selectedShift === '1stHalf' ? 15 : daysInMonth;

    const tableContainer = document.getElementById('attendance-table-container');
    tableContainer.innerHTML = '';

    // Create table element
    const table = document.createElement('table');
    table.className = 'w-full text-sm text-left text-gray-700 border-collapse';
    
    // --- TABLE HEAD ---
    const thead = table.createTHead();
    const headerRow1 = thead.insertRow();
    const headerRow2 = thead.insertRow();
    
    // NEW: Widths para sa inline style
    const fixedWidths = ['50px', '120px', '200px', '120px', '120px']; 
    const dateColWidth = '70px';
    
    // Employee Info Header (2 rows tall)
    const empInfoHeader = ['No.', 'Personnel ID', 'Personnel Name', 'Position', 'Area Posting']; 
    empInfoHeader.forEach((headerText, index) => {
        const th = document.createElement('th');
        th.rowSpan = 2;
        th.scope = 'col';
        th.textContent = headerText;
        th.className = 'sticky-col-header text-xs font-semibold uppercase tracking-wider p-3 bg-gray-100 border-r border-gray-300 z-20';
        
        // EDITED: I-inject ang inline width para masigurado ang column size
        th.style.width = fixedWidths[index];
        th.style.minWidth = fixedWidths[index]; 

        // Freeze first few columns
        if (index <= 1) th.classList.add('freeze-1', 'z-30'); // No. and ID
        if (index === 2) th.classList.add('freeze-2', 'z-30'); // Name
        headerRow1.appendChild(th);
    });

    // Date/Day Headers (First row)
    for (let d = startDay; d <= endDay; d++) {
        const dayOfMonth = new Date(year, month, d);
        const dayName = dayNames[dayOfMonth.getDay()];
        
        // --- HEADER ROW 1 (Date/Month) ---
        const th = document.createElement('th');
        th.scope = 'col';
        // EDITED: I-set ang width dito
        th.style.width = dateColWidth;
        th.style.minWidth = dateColWidth;
        th.className = 'text-xs font-semibold uppercase tracking-wider p-1 text-center border-r border-b bg-gray-100';
        th.innerHTML = `<span>${d}</span><span class="block font-medium text-[10px] uppercase text-gray-500">${monthName}</span>`; 
        headerRow1.appendChild(th);
        
        // --- HEADER ROW 2 (Day Name) ---
        const thDay = document.createElement('th');
        thDay.scope = 'col';
        thDay.textContent = dayName;
        // EDITED: Tiyakin na ang width ay pareho
        thDay.style.width = dateColWidth;
        thDay.style.minWidth = dateColWidth;
        thDay.className = 'text-xs font-medium uppercase tracking-wider p-3 text-center border-r bg-gray-50'; 
        headerRow2.appendChild(thDay);
    }
    
    // --- TABLE BODY ---
    const tbody = table.createTBody();

    // Add empty rows if no employees are loaded (up to Head Count)
    const currentEmployeeCount = currentContract.employees.length;
    const totalRowsToRender = Math.max(currentContract.headCount, currentEmployeeCount);


    for (let i = 0; i < totalRowsToRender; i++) {
        const employee = currentContract.employees[i] || { 
            no: i + 1, 
            id: '', 
            name: '', 
            position: '', 
            area: '' 
        };
        
        // CRITICAL FIX 1: Gumawa ng STABLE unique key para sa paghahanap ng pending changes.
        // Gagamitin ang employee.id (original/saved ID) kung meron, kundi ang temporary ID.
        const stableLookupKey = employee.id || `TEMP_${employee.no}`; 

        
        // CRITICAL: I-retrieve ang pending changes gamit ang stableLookupKey bilang key
        const pendingInfo = pendingEmployeeInfoChanges[stableLookupKey]; 
        
        // Gamitin ang pending data kung meron, kundi ang original/saved data
        const displayId = (pendingInfo && pendingInfo.id) ? pendingInfo.id : employee.id;
        const displayName = (pendingInfo && pendingInfo.name) ? pendingInfo.name : employee.name;
        const displayPosition = (pendingInfo && pendingInfo.position) ? pendingInfo.position : employee.position;
        const displayArea = (pendingInfo && pendingInfo.area) ? pendingInfo.area : employee.area;
        
        // NEW LOGIC: Tiyakin kung saved na ba ang row (may ID)
        const isSavedRow = !!employee.id;
        // NEW LOGIC: Tiyakin kung marked for deletion
        const isMarkedForDeletion = pendingInfo && pendingInfo.isDeleted; 

        // ** PRINTING LOGIC START: Check for blank row **
        // Kung walang Personnel ID at Name, at wala ring pending changes (maliban sa ID na blangko), i-marka para sa pagtatago sa print
        const isRowBlank = !displayId.trim() && !displayName.trim() && !Object.keys(pendingInfo || {}).length;
        // ** PRINTING LOGIC END **


        const tr = tbody.insertRow();
        tr.dataset.stableKey = stableLookupKey; // Add stable key to row for easy lookup
        
        if (isRowBlank || isMarkedForDeletion) {
             // Added class to hide the row during printing if the user selects the "Clean Print" option.
             tr.classList.add('print-empty-row'); 
        }
        
        // NEW: Kung marked for deletion, magdagdag ng visual cue
        if (isMarkedForDeletion) {
            tr.classList.add('bg-red-200', 'opacity-50', 'line-through');
        }

        
        // 1. Employee Info Cells (Fixed Columns)
        // No. (Now includes the Edit Button/Icon)
        let td = tr.insertCell();
        td.className = 'sticky-col text-center p-0 bg-gray-50 font-bold border-r border-b z-10 freeze-1 relative'; // Added relative for absolute positioning of button
        td.style.width = fixedWidths[0]; // Apply inline width
        td.style.minWidth = fixedWidths[0]; 
        
        // Content for No. cell: Number and (optionally) Edit Button
        // UPDATED: Gamitin ang CSS class `py-2` para magbigay ng vertical padding
        td.innerHTML = `<span class="block py-2">${employee.no}</span>`;
        
        if (isSavedRow) {
            // Container para sa Edit at Delete Icons
            const actionContainer = document.createElement('div');
            // NEW CLASS: Flex container para sa dalawang icon
            actionContainer.className = 'absolute top-1/2 right-0 transform -translate-y-1/2 flex space-x-0.5 pr-1 print-hidden';
            
            // Edit Button (Pen icon) for saved rows - POSITIONED INSIDE THE NO. CELL
            const editButton = document.createElement('button');
            editButton.type = 'button';
            // NEW CLASS: 'action-icon'
            editButton.className = 'action-icon p-1 text-blue-600 hover:bg-blue-200 transition duration-150 edit-row-btn rounded-full';
            editButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
            `;
            editButton.dataset.locked = isMarkedForDeletion ? 'true' : 'true'; // Force locked if marked for deletion
            editButton.dataset.stableKey = stableLookupKey;
            editButton.addEventListener('click', handleEditRowToggle);
            
            // DELETE Button (Trash icon) for saved rows
            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            // NEW CLASS: 'action-icon' at color red
            deleteButton.className = `action-icon p-1 text-red-600 hover:bg-red-200 transition duration-150 delete-row-btn rounded-full ${isMarkedForDeletion ? 'bg-red-400' : ''}`;
            deleteButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            `;
            deleteButton.dataset.stableKey = stableLookupKey;
            deleteButton.dataset.isDeleted = isMarkedForDeletion ? 'true' : 'false';
            deleteButton.addEventListener('click', handleDeleteRowToggle);
            
            // I-append ang icons sa container
            actionContainer.appendChild(editButton);
            actionContainer.appendChild(deleteButton);
            td.appendChild(actionContainer);
        } else if (!isRowBlank) {
             // Indicator for New Row (TEMP_N)
             const newLabel = document.createElement('span');
             newLabel.textContent = 'NEW';
             newLabel.className = 'new-label-no-col absolute top-1/2 right-0 transform -translate-y-1/2 mr-1 text-[8px] font-bold text-green-700 bg-green-200 px-1 py-0.5 rounded print-hidden';
             td.appendChild(newLabel);
        }

        // Personnel ID (Input)
        td = tr.insertCell();
        let input = document.createElement('input');
        input.type = 'text';
        // Gamitin ang display value
        input.value = displayId;
        input.placeholder = 'ID';
        input.maxLength = 20; 
        // UPDATED: Read-only kung saved o marked for deletion
        input.readOnly = isSavedRow || isMarkedForDeletion; 
        input.dataset.oldPersonnelId = stableLookupKey; 
        input.dataset.field = 'id';
        // NEW: Idagdag ang employee.no para sa duplicate check
        input.dataset.rowNo = employee.no; 
        // UPDATED: Add read-only class if locked or deleted
        input.className = 'personnel-info-input text-center p-1 border-none focus:ring-blue-400 w-full bg-transparent ' + (input.readOnly ? 'read-only' : ''); 
        td.appendChild(input);
        td.className = 'sticky-col p-0 bg-white border-r border-b z-10 freeze-1';
        td.style.width = fixedWidths[1]; // Apply inline width
        input.style.minWidth = fixedWidths[1]; // Tiyakin na may min width
        
        // Personnel Name (Input)
        td = tr.insertCell();
        input = document.createElement('input');
        input.type = 'text';
        input.value = displayName; // Gamitin ang display value
        input.placeholder = 'Full Name';
        input.readOnly = isSavedRow || isMarkedForDeletion; // UPDATED
        input.dataset.oldPersonnelId = stableLookupKey; // Gumamit ng stable key
        input.dataset.field = 'name';
        input.className = 'personnel-info-input p-1 border-none focus:ring-blue-400 w-full bg-transparent ' + (input.readOnly ? 'read-only' : ''); // UPDATED
        td.appendChild(input);
        td.className = 'sticky-col p-0 bg-white border-r border-b z-10 freeze-2';
        td.style.width = fixedWidths[2]; // Apply inline width
        input.style.minWidth = fixedWidths[2]; // Tiyakin na may min width
        
        // Position (Input)
        td = tr.insertCell();
        input = document.createElement('input');
        input.type = 'text';
        input.value = displayPosition; // Gamitin ang display value
        input.placeholder = 'Position';
        input.readOnly = isSavedRow || isMarkedForDeletion; // UPDATED
        input.dataset.oldPersonnelId = stableLookupKey; // Gumamit ng stable key
        input.dataset.field = 'position';
        input.className = 'personnel-info-input p-1 border-none focus:ring-blue-400 w-full bg-transparent ' + (input.readOnly ? 'read-only' : ''); // UPDATED
        td.appendChild(input);
        td.className = 'p-0 bg-white border-r border-b';
        td.style.width = fixedWidths[3]; // Apply inline width
        input.style.minWidth = fixedWidths[3]; // Tiyakin na may min width
        
        // Area Posting (Input)
        td = tr.insertCell();
        input = document.createElement('input');
        input.type = 'text';
        input.value = displayArea; // Gamitin ang display value
        input.placeholder = 'Area';
        input.readOnly = isSavedRow || isMarkedForDeletion; // UPDATED
        input.dataset.oldPersonnelId = stableLookupKey; // Gumamit ng stable key
        input.dataset.field = 'area';
        input.className = 'personnel-info-input p-1 border-none focus:ring-blue-400 w-full bg-transparent ' + (input.readOnly ? 'read-only' : ''); // UPDATED
        td.appendChild(input);
        td.className = 'p-0 bg-white border-r border-b';
        td.style.width = fixedWidths[4]; // Apply inline width
        input.style.minWidth = fixedWidths[4]; // Tiyakin na may min width


        // Add event listeners for Personnel Info updates (No auto-save)
        tr.querySelectorAll('.personnel-info-input').forEach(infoInput => {
            infoInput.addEventListener('input', (e) => handlePersonnelInfoChange(e, employee));
        });

        // 2. Attendance Plan Cells (Dynamic Dates)
        const currentPersonnelId = displayId; // Gamitin ang ID na na-save o pending

        for (let d = startDay; d <= endDay; d++) {
            // CRITICAL FIX: Direct Unpadded DayKey format (YYYY-M-D) na tugma sa Sheets
            const dayKeyUnpadded = `${year}-${month + 1}-${d}`;
            
            // CRITICAL LOOKUP PREPARATION
            const trimmedCurrentId = currentPersonnelId.toString().trim();
            const trimmedEmployeeId = employee.id.toString().trim();
            const trimmedShift = selectedShift.toString().trim();
            const trimmedDayKey = dayKeyUnpadded.toString().trim(); // Use the unpadded key for lookup

            // Check 1: Pending (Un-saved) changes
            const planKey = `${trimmedCurrentId}_${trimmedDayKey}_${trimmedShift}`; 
            const pendingStatus = pendingAttendanceChanges[planKey];

            // Check 2: Saved data (Unpadded Key)
            // Use the Saved Employee ID and the Unpadded DayKey
            const savedDataKeyUnpadded = `${trimmedEmployeeId}_${trimmedDayKey}_${trimmedShift}`;
            const savedStatusUnpadded = currentContract.planMap[savedDataKeyUnpadded] || '';


            // CRITICAL: I-prioritize ang Pending Status, Fallback to Saved Statuses
            let status = pendingStatus !== undefined ? pendingStatus : '';

            if (status === '') {
                 // Huling subok, gamitin ang na-fetch na data mula sa server (Unpadded Key)
                 if (savedStatusUnpadded !== '') {
                    status = savedStatusUnpadded;
                 }
            }
            
            td = tr.insertCell();
            // UPDATED: Gamitin ang bulk mode logic sa pagpili ng cursor
            const isSelected = bulkSelectedCells.includes(td);
            const cursorClass = isBulkSelectionMode ? 'cursor-crosshair' : 'cursor-pointer';
            
            td.className = `cell-container text-center border-r border-b transition duration-100 ease-in-out ${isMarkedForDeletion ? 'cursor-not-allowed' : cursorClass} ${isSelected ? 'cell-selected' : ''}`;
            
            // EDITED: I-apply ang inline width sa data cells
            td.style.width = dateColWidth;
            td.style.minWidth = dateColWidth;
            
            // Set cell color and content
            updateCellVisuals(td, status, dayKeyUnpadded); // Gamitin ang status na nahanap

            // Add click listener
            td.dataset.personnelId = trimmedCurrentId; 
            td.dataset.dayKey = dayKeyUnpadded; // Use Unpadded for data attributes
            td.dataset.shiftKey = trimmedShift;
            td.dataset.originalId = employee.id; 
            
            // UPDATED: Pindutin lang kung HINDI marked for deletion
            if (!isMarkedForDeletion) {
                // Initial listener setup is handleCellClick. Bulk mode will overwrite this.
                td.addEventListener('click', handleCellClick);
                
                // NEW: Kung nasa bulk mode, i-override ang listener at visual
                if (isBulkSelectionMode) {
                    td.removeEventListener('click', handleCellClick);
                    td.addEventListener('click', handleCellSelectionClick);
                }
            }
        }
    }
    
    tableContainer.appendChild(table);
  }

  // NEW FUNCTION: Handle Delete Row Toggle
  function handleDeleteRowToggle(event) {
      const button = event.currentTarget;
      const row = button.closest('tr');
      const stableKey = button.dataset.stableKey;
      const isCurrentlyDeleted = button.dataset.isDeleted === 'true';
      const inputs = row.querySelectorAll('.personnel-info-input');
      
      const employee = currentContract.employees.find(e => e.id === stableKey) || { 
          id: '', 
          name: '', 
          position: '', 
          area: '' 
      };
      
      // I-retrieve ang pending change
      let pendingChange = pendingEmployeeInfoChanges[stableKey] || {
          id: employee.id, 
          name: employee.name, 
          position: employee.position, 
          area: employee.area,
          isNew: !employee.id,
          originalEmployeeId: employee.id,
          isDeleted: false // Default to false
      };
      
      if (!isCurrentlyDeleted) {
          // MARK FOR DELETION
          // Gagamit ng custom modal UI imbes na window.confirm()
          const customConfirm = (message, onConfirm, onCancel) => {
              const modalHtml = `
                  <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-[60] flex justify-center items-center p-4">
                      <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
                          <h3 class="text-lg font-bold mb-4 text-red-700">Confirm Deletion</h3>
                          <p class="text-gray-700 mb-6">${message}</p>
                          <div class="flex justify-end space-x-3">
                              <button id="delete-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                              <button id="delete-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm Delete</button>
                          </div>
                      </div>
                  </div>
              `;
              document.body.insertAdjacentHTML('beforeend', modalHtml);
              
              document.getElementById('delete-confirm-btn').addEventListener('click', () => {
                  document.getElementById('delete-confirm-modal').remove();
                  onConfirm();
              });
              
              document.getElementById('delete-cancel-btn').addEventListener('click', () => {
                  document.getElementById('delete-confirm-modal').remove();
                  onCancel();
              });
          };

          customConfirm(`Are you sure you want to mark employee "${employee.name || stableKey}" (ID: ${employee.id}) for deletion? This will clear all schedule changes and data locally. You must click 'Save All Changes' to permanently delete from Sheets.`, 
            () => { // On Confirm
                pendingChange.isDeleted = true;
                pendingEmployeeInfoChanges[stableKey] = pendingChange;
                
                // Clear inputs and Attendance Changes for this row
                inputs.forEach(input => {
                    input.value = '';
                    input.readOnly = true;
                    input.classList.add('read-only');
                });
                
                // I-clear ang attendance changes sa pendingAttendanceChanges
                Object.keys(pendingAttendanceChanges).forEach(key => {
                    if (key.startsWith(employee.id + '_')) {
                        delete pendingAttendanceChanges[key];
                    }
                });
                
                // I-disable ang Edit button
                const editButton = row.querySelector('.edit-row-btn');
                if (editButton) {
                    editButton.dataset.locked = 'true';
                    editButton.classList.remove('text-green-600', 'hover:bg-green-200');
                    editButton.classList.add('text-blue-600', 'hover:bg-blue-200');
                    editButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    `; 
                }

                button.dataset.isDeleted = 'true';
                button.classList.add('bg-red-400');
                showNotification(`Employee ${employee.id} marked for DELETION. Click Save All Changes to proceed.`, false);
                renderAttendancePlan(); 
            }, 
            () => { // On Cancel (do nothing)
              
            }
          );
          
      } else {
          // UNDO DELETION (Revert to Original Data)
          delete pendingEmployeeInfoChanges[stableKey];
          
          // Ibalik ang original values
          inputs.forEach(input => {
              const field = input.dataset.field;
              input.value = employee[field];
              // I-lock lang kung saved row
              input.readOnly = isSavedRow;
              input.classList.toggle('read-only', isSavedRow);
          });
          
          // I-check kung may pending update sa ibang fields (maliban sa deletion), kung wala, i-delete ang key
          if (Object.keys(pendingEmployeeInfoChanges[stableKey] || {}).length === 0) {
              delete pendingEmployeeInfoChanges[stableKey];
          }

          button.dataset.isDeleted = 'false';
          button.classList.remove('bg-red-400');
          showNotification(`Deletion for Employee ${employee.id} UNDONE.`, true);
          renderAttendancePlan(); 
      }
      
  }
  
  // NEW FUNCTION: Handle Edit/Unlock Button Click (UPDATED for Deletion)
  function handleEditRowToggle(event) {
      const button = event.currentTarget;
      const row = button.closest('tr');
      const stableKey = button.dataset.stableKey;
      
      // Kunin ang current pending info para sa deletion check
      const pendingInfo = pendingEmployeeInfoChanges[stableKey];
      // Kung marked for deletion, huwag mag-allow ng edit
      if (pendingInfo && pendingInfo.isDeleted) {
          showNotification('Cannot edit: Row is marked for deletion. Undo deletion first.', false);
          return;
      }
      
      // Inputs now start from the second TD (Personnel ID)
      const inputs = row.querySelectorAll('.personnel-info-input'); 
      const isLocked = button.dataset.locked === 'true';

      if (isLocked) {
          // Unlock the inputs
          inputs.forEach(input => {
              input.readOnly = false;
              input.classList.remove('read-only');
          });

          // Change button to Lock/Save icon
          button.dataset.locked = 'false';
          button.classList.remove('text-blue-600', 'hover:bg-blue-200');
          button.classList.add('text-green-600', 'hover:bg-green-200');
          button.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
              </svg>
          `; // Checkmark icon
          showNotification('Row unlocked. Remember to click "Save All Changes" to save edits.', false);

      } else {
          // Relock the inputs (Save is handled by saveAllChanges, this only visually locks)
          inputs.forEach(input => {
              input.readOnly = true;
              input.classList.add('read-only');
          });

          // Change button back to Edit icon
          button.dataset.locked = 'true';
          button.classList.remove('text-green-600', 'hover:bg-green-200');
          button.classList.add('text-blue-600', 'hover:bg-blue-200');
          button.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
          `; // Pen icon
          showNotification('Row locked. Changes are tracked locally.', true);
      }
  }
  
  // REMOVED: handleScheduleLockToggle function

  // REMOVED: updateScheduleLockUI function

  // --- EMPLOYEE INFO HANDLERS (Manual Save) ---
  
  function handlePersonnelInfoChange(event, employee) {
      const input = event.target;
      const field = input.dataset.field;
      // CRITICAL FIX 3: Gamitin ang dataset.oldPersonnelId (stable key) bilang storage key
      const oldPersonnelKey = input.dataset.oldPersonnelId; 
      let newValue = input.value;
      
      // I-retrieve ang pending change gamit ang stable key
      let pendingChange = pendingEmployeeInfoChanges[oldPersonnelKey] || {
          id: employee.id, 
          name: employee.name, 
          position: employee.position, 
          area: employee.area,
          isNew: !employee.id,
          // Store the original ID for save logic (needed if ID changes)
          originalEmployeeId: employee.id,
          isDeleted: false // UPDATED: Default is not deleted
      };
      
      // Huwag mag-allow ng changes kung marked for deletion
      if (pendingChange.isDeleted) return;

      // --- NEW VALIDATION AND FORMATTING LOGIC ---
      if (field === 'id') {
          // 1. Validation: Only Numbers (allow empty string for now, validated on save)
          const cleanId = newValue.trim();
          // Check for non-numeric characters only if input is not empty
          if (cleanId && !PERSONNEL_ID_REGEX.test(cleanId)) {
               showNotification('Personnel ID must contain numbers only.', false);
               // Revert input value to previous clean state if invalid
               input.value = employee.id; 
               return; 
          }
          
          // --- DUPLICATE ID CHECK ---
          if (cleanId) {
              // Pass new ID, original saved ID, and current row number
              if (isDuplicateId(cleanId, employee.id, employee.no)) { 
                  showNotification(`Personnel ID "${cleanId}" is already used in another row (saved or pending).`, false);
                  input.value = employee.id; // Revert input
                  pendingChange.id = employee.id; // Revert pending change
                  // I-delete kung ang pag-revert ay nagbalik sa original state
                  if (employee.id === input.value) { 
                      delete pendingEmployeeInfoChanges[oldPersonnelKey];
                  }
                  return;
              }
          }
          // --- END DUPLICATE ID CHECK ---

          pendingChange[field] = cleanId;
      } else {
          // 2. Formatting: Convert to CAPSLOCK and remove special characters
          let cleanedValue = newValue.toUpperCase();
          // FIX: Alisin ang characters na hindi kasama sa SAFE_TEXT_REGEX (NGAYON KASAMA NA ANG DASH)
          cleanedValue = cleanedValue.replace(/[^A-Z0-9\s.,-]/g, ''); 
          
          if (cleanedValue !== newValue.toUpperCase()) {
              // Kung may inalis na special character, magbigay ng notification
              showNotification(`Special characters removed from ${field}.`, false);
          }
          
          // I-set ang input value sa cleaned value para makita ng user agad
          input.value = cleanedValue;
          pendingChange[field] = cleanedValue.trim();
          
          // --- NEW: DUPLICATE NAME CHECK (LOCAL WARNING ONLY) ---
          if (field === 'name' && pendingChange.name) {
              // Check for duplicate name using the new value
              if (isDuplicateName(pendingChange.name, employee.id, employee.no)) {
                  // UPDATED: Magbigay ng warning lang, pero hindi ire-revert ang input. Ang hard stop check ay nasa save button.
                  showNotification(`WARNING: Personnel Name "${pendingChange.name}" is already used by another employee. Please use a unique identifier (e.g., add initials/middle name).`, false);
              }
          }
          // --- END DUPLICATE NAME CHECK (LOCAL WARNING ONLY) ---
      }
      // --- END NEW VALIDATION AND FORMATTING LOGIC ---


      if (field === 'id') {
          // Manwal na i-update ang dataset.personnelId ng attendance cells
          input.closest('tr').querySelectorAll('.cell-container').forEach(cell => {
              cell.dataset.personnelId = pendingChange.id; 
          });
      }
      
      // Tiyakin na ang comparison ay ginagawa sa pagitan ng current pending data at saved data (employee.id/name/etc)
      const isChanged = (pendingChange.id !== employee.id || 
                         pendingChange.name !== employee.name || 
                         pendingChange.position !== employee.position || 
                         pendingChange.area !== employee.area ||
                         (pendingChange.originalEmployeeId === '' && pendingChange.id !== '')); // Bagong row na may laman

      if (isChanged) {
          // I-store gamit ang stableLookupKey
          pendingEmployeeInfoChanges[oldPersonnelKey] = pendingChange;
      } else {
          // Tanggalin gamit ang stableLookupKey
          delete pendingEmployeeInfoChanges[oldPersonnelKey];
      }
      
      // CRITICAL FIX 5: TANGGALIN ANG renderAttendancePlan() CALL DITO PARA HINDI MAWALA ANG FOCUS
      // renderAttendancePlan(); 
  }


  // --- ATTENDANCE PLAN HANDLERS (Manual Save) ---

  function updateCellVisuals(cell, status, dayKey) {
    const dayOfMonth = new Date(dayKey);
    const dayOfWeek = dayOfMonth.getDay(); 

    // REMOVED: isScheduleLocked check
    // UPDATED: Huwag magdagdag ng cursor-pointer kung deleted ang row
    const isDeletedRow = cell.closest('tr').classList.contains('line-through');
    
    // NEW: I-check kung nasa bulk mode para sa cursor
    const isSelected = bulkSelectedCells.includes(cell);
    const cursorClass = isBulkSelectionMode ? 'cursor-crosshair' : 'cursor-pointer';

    cell.className = `cell-container text-center border-r border-b transition duration-100 ease-in-out ${isDeletedRow ? 'cursor-not-allowed' : cursorClass} ${isSelected ? 'cell-selected' : ''}`;
    
    cell.innerHTML = `<div class="p-2 h-full w-full flex items-center justify-center text-sm font-medium attendance-cell-bg">${status}</div>`;
    const innerDiv = cell.querySelector('.attendance-cell-bg');

    let bgColor = 'bg-white';
    let textColor = 'text-gray-900';
    let isWork = false;

    if (status.length > 0) {
      if (status === 'RD') {
        bgColor = 'status-rd';
        textColor = 'text-red-700 font-bold';
      } else if (status === 'RH') {
        bgColor = 'status-rh';
        textColor = 'text-blue-700 font-bold';
      } else if (status === 'SH') {
        bgColor = 'status-sh';
        textColor = 'text-yellow-700 font-bold';
        isWork = true;
      } else {
        bgColor = 'status-work';
        textColor = 'text-green-700 font-bold';
        isWork = true;
      }
    } else {
      bgColor = 'bg-gray-100';
      textColor = 'text-gray-500';
    }
    
    // Default weekend color for blank cells
    if (!isWork && !status && (dayOfWeek === 0 || dayOfWeek === 6)) {
        bgColor = 'bg-gray-200'; 
    }
    
    // UPDATED: Kung deleted, gawing light red ang cell
    if (isDeletedRow) {
        bgColor = 'bg-red-300';
        textColor = 'text-red-500';
        status = 'DELETED';
        innerDiv.textContent = status;
    }
    
     innerDiv.className = `p-2 h-full w-full flex items-center justify-center text-sm font-medium attendance-cell-bg ${bgColor} ${textColor}`;
  }


  function handleCellClick(event) {
    // *** NEW LOGIC: Huwag buksan ang modal kung nasa bulk selection mode ***
    if (isBulkSelectionMode) return; 
    
    const targetCell = event.currentTarget;
    const personnelId = targetCell.dataset.personnelId; 
    const originalId = targetCell.dataset.originalId; 
    const dayKey = targetCell.dataset.dayKey;
    const shiftKey = targetCell.dataset.shiftKey;
    
    // UPDATED: Check for deletion status
    if (targetCell.closest('tr').classList.contains('line-through')) {
        showNotification('Cannot edit: Row is marked for deletion. Undo deletion first.', false);
        return;
    }
    
    if (!personnelId && !originalId) { 
        showNotification('Cannot edit: Personnel ID is empty. Please fill in the ID field first.', false);
        return;
    }

    const planKey = `${personnelId}_${dayKey}_${shiftKey}`;
    
    const currentStatus = pendingAttendanceChanges[planKey] !== undefined 
                          ? pendingAttendanceChanges[planKey] 
                          : currentContract.planMap[`${originalId}_${dayKey}_${shiftKey}`] || '';

    selectedCellData = {
      personnelId, 
      originalId,  
      dayKey,
      shiftKey,
      cellElement: targetCell
    };

    const modal = document.getElementById('floating-status-modal');
    // I-reference ang bagong select pickers
    const inputStartTime = document.getElementById('schedule-start-time');
    const inputEndTime = document.getElementById('schedule-end-time');
    
    const fixedOptionsContainer = document.getElementById('fixed-status-options-container');

    fixedOptionsContainer.innerHTML = '';
    
    fixedStatusOptions.forEach(option => {
        const button = document.createElement('button');
        button.type = 'button';
        button.textContent = option.label;
        button.value = option.value;
        button.className = `w-full px-4 py-2 text-sm rounded-lg border hover:shadow-md transition duration-150 ${option.color} ${option.value === currentStatus ? 'bg-opacity-70 border-2 border-blue-500' : 'bg-opacity-50 border-gray-300'}`;
        button.addEventListener('click', (e) => saveSchedule(e, option.value));
        fixedOptionsContainer.appendChild(button);
    });
    
    // 1. Clear and Populate Dropdowns
    inputStartTime.innerHTML = '<option value="">-- Start Time --</option>';
    inputEndTime.innerHTML = '<option value="">-- End Time --</option>';

    TIME_OPTIONS.forEach(time => {
        let optionStart = document.createElement('option');
        optionStart.value = time;
        optionStart.textContent = time;
        inputStartTime.appendChild(optionStart);
        
        let optionEnd = document.createElement('option');
        optionEnd.value = time;
        optionEnd.textContent = time;
        inputEndTime.appendChild(optionEnd);
    });


    // 2. Set Selected Values
    if (currentStatus && !fixedStatusCodes.includes(currentStatus)) {
        const parts = currentStatus.split('-');
        inputStartTime.value = parts[0] || '';
        inputEndTime.value = parts[1] || '';
    } else {
        inputStartTime.value = '';
        inputEndTime.value = '';
    }

    modal.classList.remove('hidden');
    inputStartTime.focus(); // Focus sa start time
  }
  
  document.getElementById('cancel-status-btn').addEventListener('click', () => {
      document.getElementById('floating-status-modal').classList.add('hidden');
  });
  
  document.getElementById('save-schedule-btn').addEventListener('click', (event) => {
      // Walang schedule parameter dito, dahil kukunin natin ito sa inputs
      saveSchedule(event, null); 
  });


  function saveSchedule(event, fixedStatusValue) {
    document.getElementById('floating-status-modal').classList.add('hidden');
    
    if (!selectedCellData.personnelId && !selectedCellData.originalId) return; 

    const { personnelId, originalId, dayKey, shiftKey, cellElement } = selectedCellData;

    let finalStatus;
    
    if (event.type === 'click' && fixedStatusValue !== null) {
        // Fixed status button was clicked
        finalStatus = fixedStatusValue;
    } else {
        // 'Save' button was clicked (Schedule input is primary)
        const inputStartTime = document.getElementById('schedule-start-time').value.trim();
        const inputEndTime = document.getElementById('schedule-end-time').value.trim();

        if (inputStartTime && inputEndTime) {
            finalStatus = `${inputStartTime}-${inputEndTime}`;
        } else if (inputStartTime || inputEndTime) {
            // Incomplete time pair, treat as invalid
            showNotification('Please select both start and end times, or use the fixed status buttons.', false); // Change prompt to 'select'
            setTimeout(() => handleCellClick({ currentTarget: selectedCellData.cellElement }), 100); 
            return;
        } else {
            // Both time inputs are blank, treat as clearing the schedule status
            finalStatus = '';
        }
    }
    
    if (!personnelId) {
        showNotification('Cannot save plan: Personnel ID is missing for this row.', false);
        return;
    }

    // Since we use select, we trust the browser for HH:MM format, but we check the combined length/structure
    if (!fixedStatusCodes.includes(finalStatus) && finalStatus.length > 0) {
        // Tiyakin na ang resultang string ay HH:MM-HH:MM (11 characters)
        if (finalStatus.length !== 11 || finalStatus.charAt(5) !== '-') {
             showNotification('Invalid schedule format detected.', false);
             setTimeout(() => handleCellClick({ currentTarget: selectedCellData.cellElement }), 100); 
             return;
        }
        
        // === NEW VALIDATION: End Time MUST NOT be before Start Time ===
        const [startTime, endTime] = finalStatus.split('-');
        const startTimeValue = parseInt(startTime.replace(':', ''), 10);
        const endTimeValue = parseInt(endTime.replace(':', ''), 10);
        
        if (endTimeValue < startTimeValue) {
             showNotification('FATAL ERROR: End Time cannot be earlier than Start Time. Please correct the schedule.', false);
             // Re-open modal to allow correction
             setTimeout(() => handleCellClick({ currentTarget: selectedCellData.cellElement }), 100); 
             return;
        }
        // === END NEW VALIDATION ===
    }

    const currentPlanKey = `${personnelId}_${dayKey}_${shiftKey}`;
    const originalPlanKey = `${originalId}_${dayKey}_${shiftKey}`;

    const originalStatus = currentContract.planMap[originalPlanKey] || '';

    // --- EDITED LOGIC: Tracking blank status ---
    if (originalStatus !== finalStatus) {
        // I-store ang finalStatus, kahit na blangko ('')
        pendingAttendanceChanges[currentPlanKey] = finalStatus; 
    } else {
        // Kung bumalik sa original status (kahit blangko), tanggalin sa pending.
        delete pendingAttendanceChanges[currentPlanKey];
    }
    // --- END EDITED LOGIC ---
    
    updateCellVisuals(cellElement, finalStatus, dayKey);
    
    // Walang re-render dito
    
    showNotification('Change saved locally. Click "Save All Changes" to save to Sheets.', true);
  }
  
  function handleSaveAllChanges() {
    // CRITICAL: Gamitin ang SFC Ref# bilang key
    const sfcRefToSave = currentContract ? currentContract.sfcRef : null;
    const currentYear = currentPlanningDate.getFullYear();
    const currentMonth = currentPlanningDate.getMonth();
    const currentShift = document.getElementById('shift-period-select').value;
    
    // NEW: Check if in Bulk Selection Mode and force exit
    if (isBulkSelectionMode) {
        exitBulkSelectionMode();
        showNotification('Bulk Selection Mode was active. Please review the selection before saving.', false);
        // We will continue the save process, but this is a good warning
    }


    // CRITICAL FIX 4: I-convert ang pendingEmployeeInfoChanges bago ipadala sa server.
    const empChanges = Object.keys(pendingEmployeeInfoChanges).map(stableKey => {
        const change = pendingEmployeeInfoChanges[stableKey];
        
        return {
            // Ito ang gagamitin ng server para hanapin ang row
            oldPersonnelId: change.originalEmployeeId, // Dapat ito ang original saved ID (o '')
            // Ito ang bagong data
            id: change.id,
            name: change.name,
            position: change.position,
            area: change.area,
            isNew: change.originalEmployeeId === '', // Flag para sa bagong row
            isDeleted: change.isDeleted || false // UPDATED: I-pass ang deletion flag
        };
    })
    // Filter: 1. Deleted rows 2. New rows with content 3. Updated existing rows
    .filter(e => e.isDeleted || (e.isNew && e.id.trim() !== '' && e.name.trim() !== '') || (!e.isNew && (e.id.trim() !== e.oldPersonnelId || e.name.trim() !== currentContract.employees.find(emp => emp.id === e.oldPersonnelId)?.name || e.position.trim() !== currentContract.employees.find(emp => emp.id === e.oldPersonnelId)?.position || e.area.trim() !== currentContract.employees.find(emp => emp.id === e.oldPersonnelId)?.area))); 
    
    // Safety check: Filter out fully empty NEW rows, but allow fully empty DELETED rows to pass
    // Final check bago ipadala
    const finalEmpChanges = [];
    empChanges.forEach(e => {
        if (e.isDeleted) {
            finalEmpChanges.push(e); // Allow deleted rows to pass regardless of content
        } else if (e.isNew && e.id.trim() !== '' && e.name.trim() !== '') {
            finalEmpChanges.push(e); // Only allow new rows if ID and Name are filled
        } else if (!e.isNew) {
            finalEmpChanges.push(e); // Allow updates to existing rows
        }
    });


    // === CRITICAL 1: FINAL DUPLICATE NAME CHECK BEFORE SAVE ===
    const namesToCheck = {};
    let duplicateNameFound = false;
    
    // Combine saved (non-deleted) and pending (non-deleted, non-new) names
    currentContract.employees.forEach(emp => {
        // Exclude employees that are being deleted
        const isPendingDelete = pendingEmployeeInfoChanges[emp.id]?.isDeleted;
        if (!isPendingDelete) {
            namesToCheck[emp.name.toUpperCase().trim()] = emp.id;
        }
    });

    // Check pending changes (New and Updated)
    for (const change of finalEmpChanges) {
        if (change.isDeleted) continue; // Skip deleted items

        const nameKey = change.name.toUpperCase().trim();
        const existingId = namesToCheck[nameKey];

        // Check if the name already exists AND it belongs to a different ID
        if (existingId && existingId !== change.oldPersonnelId) {
            duplicateNameFound = true;
            break;
        }

        // Add or update the name in the check map
        namesToCheck[nameKey] = change.id || change.oldPersonnelId;
    }

    if (duplicateNameFound) {
        showNotification('FATAL ERROR: Cannot save. Duplicate Personnel Name detected. Please edit the name to be unique (e.g., add initials/middle name) before saving.', false);
        return; // HARD STOP SAVE
    }
    // === END FINAL DUPLICATE NAME CHECK ===
    
    // === CRITICAL 2: CHECK FOR BLANK ATTENDANCE COLUMNS (Missing Schedule/Status) ===
    const activeEmployees = getActiveEmployeesInGrid();
    let incompleteColumnFound = false;
    let employeeNameIncomplete = '';
    
    if (activeEmployees.length === 0 && currentContract.headCount > 0) {
        showNotification(`FATAL ERROR: Cannot save. Employee rows must be filled up to the Total Head Count (${currentContract.headCount}) before setting the plan.`, false);
        return;
    }
    
    // Tiyakin na ang bawat empleyado ay may schedule/status sa bawat araw sa kasalukuyang shift
    for (const employee of activeEmployees) {
        for (const cell of employee.planCells) {
            if (cell.status === '') {
                incompleteColumnFound = true;
                employeeNameIncomplete = employee.name;
                break;
            }
        }
        if (incompleteColumnFound) break;
    }

    if (incompleteColumnFound) {
        showNotification(`FATAL ERROR: Cannot save. Attendance Plan incomplete for employee: ${employeeNameIncomplete}. All days in the current shift/period must have a status (Work, RD, RH, or SH).`, false);
        return; // HARD STOP SAVE
    }
    // === END CHECK FOR BLANK ATTENDANCE COLUMNS ===


    const attChanges = Object.keys(pendingAttendanceChanges).map(key => {
        const [personnelId, dayKey, shift] = key.split('_');
        return { personnelId, dayKey, shift, status: pendingAttendanceChanges[key] };
    });

    if (finalEmpChanges.length === 0 && attChanges.length === 0) {
        showNotification('No changes detected to save.', false);
        return;
    }
    
    // Safety check: Final validation before sending to server (Numeric ID check)
    if (finalEmpChanges.some(e => !e.isDeleted && !PERSONNEL_ID_REGEX.test(e.id.trim()))) {
        showNotification('Personnel ID error detected (must be numbers only). Please check your inputs.', false);
        return;
    }
    
    // --- CRITICAL ID VALIDATION (Strict Check) ---
    if (!sfcRefToSave) {
        showNotification('CRITICAL ERROR: Contract data is not loaded. Please select a Contract Group ID and retry.', false);
        return;
    }
    // --- END CRITICAL ID VALIDATION ---
    
    // 2. I-prepare ang Contract Info
    const contractInfo = {
        payor: currentContract.payorCompany,
        agency: currentContract.agency,
        serviceType: currentContract.serviceType,
        headCount: currentContract.headCount
    };

    toggleLoading(true);
    
    google.script.run
        .withSuccessHandler(handleSaveAllSuccess)
        .withFailureHandler(handleSaveAllError)
        .saveAllData(sfcRefToSave, contractInfo, finalEmpChanges, attChanges, currentYear, currentMonth, currentShift); // PASS ALL CONTEXT
  }

  function handleSaveAllSuccess(response) {
      showNotification('All changes saved successfully! Refreshing data...', true);
      // CRITICAL: I-clear ang pendingEmployeeInfoChanges para ma-load ang fresh data
      pendingAttendanceChanges = {}; 
      pendingEmployeeInfoChanges = {}; 
      
      // I-fetch ulit ang data para ma-load ang na-save na plan
      fetchAttendanceData(currentContract.sfcRef); // Pass SFC Ref#
  }

  function handleSaveAllError(error) {
       console.error("SAVE ALL ERROR:", error);
       showNotification(`FATAL SAVE ERROR: ${error.message || 'An unknown error occurred during saving.'}`, false);
       toggleLoading(false); 
  }
  
  // --- NEW PRINT LOGIC (UPDATED: Check for pending changes first) ---

function triggerPrint(refNum) {
    showNotification(`Print Reference #${refNum} generated and logged. Printing now...`, true);

    // 1. Tanggalin ang mga blangkong row
    const emptyRows = document.querySelectorAll('.print-empty-row');
    emptyRows.forEach(row => row.classList.add('print-hidden'));

    // 2. I-convert ang input fields sa read-only text (para ma-print ang values)
    const inputs = document.querySelectorAll('#attendance-table-container input');
    
    inputs.forEach(input => {
        // Tiyakin na read-only ang lahat ng inputs habang nagpi-print.
        input.classList.add('print-read-only');
    });

    // 3. I-trigger ang print dialog
    window.print();

    // 4. Ibalik ang mga tinanggal na element pagkatapos ng print (sa 'afterprint' event)
    window.addEventListener('afterprint', () => {
        emptyRows.forEach(row => row.classList.remove('print-hidden'));
        inputs.forEach(input => {
            // Tanggalin ang temporary print class
            input.classList.remove('print-read-only');
        });
    }, { once: true }); 
}


function handlePrintPlan() {
    if (!currentContract) {
        showNotification('Please select a Contract Group ID first.', false);
        return;
    }
    
    // Check 1: Pending Changes
    const empChangesCount = Object.keys(pendingEmployeeInfoChanges).length;
    const attChangesCount = Object.keys(pendingAttendanceChanges).length;
    
    if (empChangesCount > 0 || attChangesCount > 0) {
        showNotification(`Saving required: ${empChangesCount} employee changes and ${attChangesCount} schedule changes are pending. Click "Save All Changes to Sheets" first.`, false);
        return;
    }
    
    // Check 2: All Data Integrity (Same as Save All) - Prevent printing incomplete plans
    const activeEmployees = getActiveEmployeesInGrid();
    let incompleteColumnFound = false;
    
    for (const employee of activeEmployees) {
        for (const cell of employee.planCells) {
            if (cell.status === '') {
                incompleteColumnFound = true;
                break;
            }
        }
        if (incompleteColumnFound) break;
    }

    if (incompleteColumnFound) {
        showNotification(`FATAL ERROR: Cannot print. Attendance Plan is incomplete. All days in the current shift/period must have a status (Work, RD, RH, or SH).`, false);
        return;
    }

    // 3. Prepare Context for Logging
    const currentYear = currentPlanningDate.getFullYear();
    const currentMonth = currentPlanningDate.getMonth();
    const currentShift = document.getElementById('shift-period-select').value;
    
    const contractInfo = {
        payor: currentContract.payorCompany,
        agency: currentContract.agency,
        serviceType: currentContract.serviceType,
        headCount: currentContract.headCount
    };

    toggleLoading(true);

    // 4. Call Server to Log Print Action and get Ref #
    google.script.run
        .withSuccessHandler((refNum) => {
            toggleLoading(false);
            triggerPrint(refNum);
        })
        .withFailureHandler((error) => {
            handleError(error);
        })
        .logPrintAction(currentContract.sfcRef, contractInfo, currentYear, currentMonth, currentShift);
}


// --- NEW: BULK SELECTION LOGIC ---

// Helper function to update bulkSelectedCells array and visuals
function toggleCellSelection(cellElement) {
    // Check if the cell is already in the array (using reference equality for DOM elements)
    const index = bulkSelectedCells.indexOf(cellElement);
    
    if (index > -1) {
        // Remove selection
        bulkSelectedCells.splice(index, 1);
        cellElement.classList.remove('cell-selected');
    } else {
        // Add selection
        bulkSelectedCells.push(cellElement);
        cellElement.classList.add('cell-selected');
    }
    document.getElementById('bulk-cell-count').textContent = bulkSelectedCells.length;
    document.getElementById('bulk-save-btn').disabled = bulkSelectedCells.length === 0;
}


// New handler for cell clicks during bulk mode
function handleCellSelectionClick(event) {
    const targetCell = event.currentTarget;
    
    // Safety check: Cannot select cells without ID or if the row is marked for deletion
    if (targetCell.closest('tr').classList.contains('line-through')) {
        showNotification('Cannot select: Row is marked for deletion.', false);
        return;
    }
    if (!targetCell.dataset.personnelId && !targetCell.dataset.originalId) { 
        showNotification('Cannot select: Personnel ID is empty for this row.', false);
        return;
    }
    
    toggleCellSelection(targetCell);
}

// Function to start the bulk selection process
function startBulkSelectionMode() {
    if (isBulkSelectionMode) return; // Already in mode

    isBulkSelectionMode = true;
    bulkSelectedCells = []; // Clear previous selection

    // 1. I-clear at i-set ang bagong click handler sa lahat ng cells
    document.querySelectorAll('.cell-container').forEach(cell => {
        // I-alis ang old handler (handleCellClick)
        cell.removeEventListener('click', handleCellClick);
        // I-dagdag ang new handler (handleCellSelectionClick)
        cell.addEventListener('click', handleCellSelectionClick);
        cell.classList.add('cursor-crosshair'); // Visual cue for selection mode
    });
    
    // 2. I-update ang UI ng Bulk Button
    const bulkBtn = document.getElementById('start-bulk-select-btn');
    bulkBtn.textContent = 'Apply Selection';
    bulkBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
    bulkBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
    // We add the openBulkScheduleModal listener here
    bulkBtn.removeEventListener('click', startBulkSelectionMode); // Remove old listener
    bulkBtn.addEventListener('click', openBulkScheduleModal); 

    showNotification('Bulk Selection Mode: Click cells to select them. Click "Apply Selection" when finished.', true);
}


// Function to return to normal mode (called after save or cancel)
function exitBulkSelectionMode() {
    isBulkSelectionMode = false;
    
    // 1. I-restore ang original click handler at i-clear ang selection
    document.querySelectorAll('.cell-container').forEach(cell => {
        cell.removeEventListener('click', handleCellSelectionClick);
        // I-restore ang old handler (handleCellClick)
        cell.addEventListener('click', handleCellClick); 
        cell.classList.remove('cell-selected', 'cursor-crosshair');
    });
    
    bulkSelectedCells = [];
    document.getElementById('bulk-cell-count').textContent = '0';
    
    // 2. I-restore ang UI ng Bulk Button
    const bulkBtn = document.getElementById('start-bulk-select-btn');
    bulkBtn.textContent = 'Start Bulk Select';
    bulkBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    bulkBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
    bulkBtn.removeEventListener('click', openBulkScheduleModal); // Remove modal open listener
    bulkBtn.addEventListener('click', startBulkSelectionMode); // Re-add start mode listener

    // Ensure the modal is hidden
    document.getElementById('floating-bulk-modal').classList.add('hidden');

    showNotification('Bulk Selection Mode ended.', false);
}


// Function to open the Bulk Modal
function openBulkScheduleModal() {
    if (bulkSelectedCells.length === 0) {
        showNotification('Please select at least one cell first.', false);
        return;
    }
    
    const modal = document.getElementById('floating-bulk-modal');
    const inputStartTime = document.getElementById('bulk-start-time');
    const inputEndTime = document.getElementById('bulk-end-time');
    const fixedOptionsContainer = document.getElementById('bulk-fixed-status-options-container');

    // 1. Populate Fixed Status Options
    fixedOptionsContainer.innerHTML = '';
    fixedStatusOptions.forEach(option => {
        const button = document.createElement('button');
        button.type = 'button';
        button.textContent = option.label;
        button.value = option.value;
        // Use a simpler style for bulk buttons
        button.className = `w-full px-4 py-2 text-sm rounded-lg border hover:shadow-md transition duration-150 ${option.color} bg-opacity-50 border-gray-300`;
        // Pass the fixed value directly to the save function
        button.addEventListener('click', (e) => saveBulkSchedule(e, option.value)); 
        fixedOptionsContainer.appendChild(button);
    });
    
    // 2. Populate Time Options (Same as single modal)
    inputStartTime.innerHTML = '<option value="">-- Start Time --</option>';
    inputEndTime.innerHTML = '<option value="">-- End Time --</option>';

    TIME_OPTIONS.forEach(time => {
        let optionStart = document.createElement('option');
        optionStart.value = time;
        optionStart.textContent = time;
        inputStartTime.appendChild(optionStart);
        
        let optionEnd = document.createElement('option');
        optionEnd.value = time;
        optionEnd.textContent = time;
        inputEndTime.appendChild(optionEnd);
    });
    
    // Clear time selection from previous use
    inputStartTime.value = '';
    inputEndTime.value = '';

    // 3. Set display count and open
    document.getElementById('bulk-cell-count').textContent = bulkSelectedCells.length;
    modal.classList.remove('hidden');
    document.getElementById('bulk-save-btn').disabled = bulkSelectedCells.length === 0;
}

// Function to save the schedule to all selected cells
function saveBulkSchedule(event, fixedStatusValue) {
    document.getElementById('floating-bulk-modal').classList.add('hidden');
    
    let finalStatus = '';
    
    if (event.type === 'click' && fixedStatusValue !== null) {
        // Fixed status button was clicked (e.g., RD, RH, SH, or Clear)
        finalStatus = fixedStatusValue;
    } else {
        // 'Apply Schedule' button was clicked (Schedule input is primary)
        const inputStartTime = document.getElementById('bulk-start-time').value.trim();
        const inputEndTime = document.getElementById('bulk-end-time').value.trim();

        if (inputStartTime && inputEndTime) {
            finalStatus = `${inputStartTime}-${inputEndTime}`;
        } else if (inputStartTime || inputEndTime) {
             showNotification('Please select both start and end times, or use the fixed status buttons.', false); 
             // Re-open modal to allow correction
             setTimeout(openBulkScheduleModal, 100); 
             return;
        } else {
            // Both time inputs are blank, treat as clearing the schedule status
            finalStatus = '';
        }
    }
    
    // Check if a time schedule was entered
    if (!fixedStatusCodes.includes(finalStatus) && finalStatus.length > 0) {
        // Tiyakin na ang resultang string ay HH:MM-HH:MM (11 characters)
        if (finalStatus.length !== 11 || finalStatus.charAt(5) !== '-') {
             showNotification('Invalid schedule format detected.', false);
             setTimeout(openBulkScheduleModal, 100); 
             return;
        }
        
        // === NEW VALIDATION: End Time MUST NOT be before Start Time ===
        const [startTime, endTime] = finalStatus.split('-');
        const startTimeValue = parseInt(startTime.replace(':', ''), 10);
        const endTimeValue = parseInt(endTime.replace(':', ''), 10);
        
        if (endTimeValue < startTimeValue) {
             showNotification('FATAL ERROR: End Time cannot be earlier than Start Time. Please correct the schedule.', false);
             // Re-open modal to allow correction
             setTimeout(openBulkScheduleModal, 100); 
             return;
        }
        // === END NEW VALIDATION ===
    }
    
    let changesAppliedCount = 0;

    bulkSelectedCells.forEach(cellElement => {
        const personnelId = cellElement.dataset.personnelId; 
        const originalId = cellElement.dataset.originalId; 
        const dayKey = cellElement.dataset.dayKey;
        const shiftKey = cellElement.dataset.shiftKey;
        
        if (!personnelId) return; // Skip if no ID

        const currentPlanKey = `${personnelId}_${dayKey}_${shiftKey}`;
        const originalPlanKey = `${originalId}_${dayKey}_${shiftKey}`;

        const originalStatus = currentContract.planMap[originalPlanKey] || '';
        
        // Update pending changes
        if (originalStatus !== finalStatus) {
            pendingAttendanceChanges[currentPlanKey] = finalStatus; 
        } else {
            delete pendingAttendanceChanges[currentPlanKey];
        }
        
        // Update cell visuals
        updateCellVisuals(cellElement, finalStatus, dayKey);
        changesAppliedCount++;
    });
    
    // Exit bulk mode and show success notification
    exitBulkSelectionMode();
    showNotification(`Bulk schedule applied to ${changesAppliedCount} cells. Click "Save All Changes" to save to Sheets.`, true);
}


  // --- INITIALIZATION ---

  window.onload = function() {
    toggleLoading(true);
    google.script.run
      .withSuccessHandler(handleContractList)
      .withFailureHandler(handleError)
      .getContracts();
  }
</script>
